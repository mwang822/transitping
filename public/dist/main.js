(()=>{const e=document.getElementById("trainResponse"),t=document.getElementById("busResponse"),n=document.getElementById("status");function o(e,t){const n=new URLSearchParams;return n.append("wayPoint.1",`${e.lat},${e.lon}`),n.append("wayPoint.2",`${t.lat},${t.lon}`),n.append("ra","routeSummariesOnly"),n.append("key","AgABNf69TNOhfktEdaM_VXgsALbx4Rt4ih00qLabWszbrukFBCOS_LSDD1iZRWar"),fetch(`https://dev.virtualearth.net/REST/v1/Routes/walking?${n.toString()}`)}function s(e){for(var t in res="",e){let n="";for(let o=0;o<Math.min(e[t].length,4);o++)n+=`${e[t][o]}, `;n=n.substring(0,n.length-2),res+=`<p>Route: ${t}&nbsp;&nbsp;&nbsp;ETA: ${n} mins</p>`}return res}document.addEventListener("DOMContentLoaded",(function(){document.querySelector(".collapsible").style.display="block",document.querySelector(".content").style.display="block",document.querySelector(".collapsible").addEventListener("click",(function(){this.classList.toggle("active");var e=this.nextElementSibling;"block"===e.style.display?e.style.display="none":e.style.display="block"}))})),async function(){let a=await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t)}));userCoords={lat:a.coords.latitude,lon:a.coords.longitude},n.innerHTML="Got user location! Getting transit data...";let i=await function(e){const t=new URLSearchParams;return t.append("lat",e.lat),t.append("lon",e.lon),fetch(`https://transitping-mtapi.onrender.com/by-location?${t.toString()}`)}(userCoords),r=await i.json();r=r.data;let l="";for(let e=0;e<3;e++){let t,n,i={},u={};t=r[e].N,n=r[e].S,walkTimeRes=await o({lat:a.coords.latitude,lon:a.coords.longitude},{lat:r[e].location[0],lon:r[e].location[1]});let p=await walkTimeRes.json(),c=Math.round(p.resourceSets[0].resources[0].travelDuration/60);l+=`<h2 class="station-name">${r[e].name}&nbsp;&nbsp;&nbsp;&nbsp;&#128694;${c}mins</h2>`,l+='<div class="direction north">',l+="<p>Northbound Trains</p>";for(let n=0;n<t.length;n++){let o=Math.round((new Date(t[n].time)-Date.now())/6e4);r[e].N[n].route in i?i[r[e].N[n].route].push(o):i[r[e].N[n].route]=[o]}l+=s(i),l+='<div class="direction south">',l+="<p>Southbound Trains</p>";for(let e=0;e<n.length;e++){let t=Math.round((new Date(n[e].time)-Date.now())/6e4);n[e].route in u?u[n[e].route].push(t):u[n[e].route]=[t]}l+=s(u),l+="</div>",l+="</div>"}n.remove(),e.innerHTML=`${l}`,busData=await async function(e){let t=new URLSearchParams;t.append("lat",e.lat),t.append("lon",e.lon),t.append("latSpan",.005),t.append("lonSpan",.005),t.append("key","d7cdf7f2-042c-4657-993f-97823a8bd34d"),nearbyStops=await fetch(`https://bustime.mta.info/api/where/stops-for-location.json?${t.toString()}`),nearbyStops=await nearbyStops.json(),nearbyStops=nearbyStops.data.stops;const n={};for(let e=0;e<Math.min(3,nearbyStops.length);e++)t=new URLSearchParams,t.append("version",2),t.append("StopMonitoringDetailLevel","minimum"),t.append("key","d7cdf7f2-042c-4657-993f-97823a8bd34d"),t.append("MonitoringRef",nearbyStops[e].code),stopRes=await fetch(`https://bustime.mta.info/api/siri/stop-monitoring.json?${t.toString()}`),stopRes=await stopRes.json(),stopRes=stopRes.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit,n[nearbyStops[e].name]=stopRes;return n}(userCoords),upcomingBuses={};for(let e in busData){upcomingBuses[e]={},console.log(busData[e]);for(let t=0;t<busData[e].length;t++)bus_i=busData[e][t].MonitoredVehicleJourney,bus_i.PublishedLineName[0]in upcomingBuses[e]?upcomingBuses[e][bus_i.PublishedLineName[0]][1].push(bus_i.MonitoredCall.ArrivalProximityText):(upcomingBuses[e][bus_i.PublishedLineName[0]]=[[bus_i.DestinationName[0]],[bus_i.MonitoredCall.ArrivalProximityText]],console.log(upcomingBuses))}for(let e in upcomingBuses){l='<div class="content">',l+=`<h2>${e}</h2>`;for(let t in upcomingBuses[e]){l+=`<p>${t} ---\x3e ${upcomingBuses[e][t][0]}</p>`,eta="";for(let n=0;n<Math.min(3,upcomingBuses[e][t][1].length);n++)eta+=`${upcomingBuses[e][t][1][n]}, `;l+=`<p>ETA: ${eta.substring(0,eta.length-2)}</p>`}l+="</div>"}t.innerHTML=l}().catch((e=>n.innerHTML=e))})();